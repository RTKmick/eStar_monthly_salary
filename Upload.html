<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
      body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; padding: 15px; background: #f4f4f4; text-align: center; color: #333; }
      .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
      h3 { margin-top: 0; margin-bottom: 15px; font-weight: 600; color: #2c3e50; }
      
      .btn { 
        display: block; width: 100%; padding: 12px; margin-top: 10px; 
        border: none; border-radius: 6px; cursor: pointer; 
        font-size: 15px; font-weight: 500; transition: all 0.2s ease; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .btn:active { transform: translateY(1px); box-shadow: none; }
      .btn:disabled { background: #ccc !important; cursor: not-allowed; transform: none; box-shadow: none; }

      .btn-primary { background: #007bff; color: white; } /* è—è‰²ï¼šæ‰‹å‹• */
      .btn-primary:hover { background: #0056b3; }
      
      #log { margin-top: 15px; font-size: 13px; text-align: left; background: #2d3436; color: #dfe6e9; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto; display: none; font-family: monospace; }
      
      input[type="file"] { margin-top: 10px; font-size: 14px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>ğŸ“ æ‰“å¡è³‡æ–™åŒ¯å…¥ç³»çµ±</h3>
      
      <p style="margin:0 0 5px; font-size:14px; color:#666;">è«‹é¸æ“‡ã€Œæ‰“å¡ä¹‹æ˜Ÿã€åŒ¯å‡ºçš„ Excel æª”æ¡ˆ</p>
      
      <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" />
      
      <button id="manualBtn" class="btn btn-primary" onclick="manualImport()">
        ğŸš€ é–‹å§‹åŒ¯å…¥
      </button>
      
      <div id="log"></div>
    </div>

    <script src="config.js"></script>

    <script>
      // --- â˜… 2. æª¢æŸ¥è¨­å®šæª” ---
      if (typeof CONFIG === 'undefined') {
          alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° config.jsï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³è‡³ GitHubã€‚");
      }
      const GAS_API_URL = CONFIG.API_URL;

      // === è¼”åŠ©å‡½å¼ ===
      function log(msg, type='') {
        const logDiv = document.getElementById('log');
        logDiv.style.display = 'block';
        
        let color = '#dfe6e9'; // é è¨­ç™½
        if (type === 'error') color = '#ff7675'; // ç´…
        if (type === 'success') color = '#55efc4'; // ç¶ 
        
        const timestamp = new Date().toLocaleTimeString('en-US', {hour12: false});
        logDiv.innerHTML += `<div style="color:${color}; border-bottom:1px solid #444; padding:2px 0;">[${timestamp}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function toggleAll(isLoading, loadingText = '') {
         const ids = ['manualBtn', 'excelFile'];
         ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.disabled = isLoading;
         });
         
         if(loadingText) {
             const btn = document.getElementById('manualBtn');
             if(!btn.getAttribute('data-original-text')) {
                 btn.setAttribute('data-original-text', btn.innerText);
             }
             btn.innerText = loadingText;
         } else {
             const btn = document.getElementById('manualBtn');
             const original = btn.getAttribute('data-original-text');
             if(original) btn.innerText = original;
         }
      }

      // --- â˜… æ ¸å¿ƒï¼šAPI å‘¼å« ---
      function callApi(action, data) {
          return fetch(GAS_API_URL, {
              method: "POST",
              body: JSON.stringify({ action: action, data: data })
          })
          .then(res => res.json());
      }

      // --- åŠŸèƒ½ï¼šæ‰‹å‹•åŒ¯å…¥ ---
      function manualImport() {
        const fileInput = document.getElementById('excelFile');
        if (typeof XLSX === 'undefined') { log("âŒ Excel å·¥å…·åŒ…è¼‰å…¥å¤±æ•—", 'error'); return; }
        if (fileInput.files.length === 0) { log("âŒ è«‹å…ˆé¸æ“‡æª”æ¡ˆ", 'error'); return; }

        toggleAll(true, "â³ è™•ç†ä¸­...");
        log("â³ è®€å–ä¸Šå‚³æª”æ¡ˆä¸­...");
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          processData(data);
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
      }

      // ==========================================================
      // â˜…â˜…â˜… é»ƒé‡‘è§£æé‚è¼¯ (Golden Logic) â˜…â˜…â˜…
      // ==========================================================
      function processData(data) {
        try {
            const workbook = XLSX.read(data, {type: 'array'});
            
            if (workbook.SheetNames.length < 2) throw new Error("æ­¤æª”æ¡ˆåªæœ‰ 1 å€‹åˆ†é ï¼Œæ‰¾ä¸åˆ°ç¬¬ 2 é  (Rawdata)ï¼");
            const sheetName = workbook.SheetNames[1]; 
            log(`ğŸ“„ è®€å–åˆ†é : [${sheetName}]`);
            
            const worksheet = workbook.Sheets[sheetName];
            const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});

            if (rawData.length < 2) throw new Error("æª”æ¡ˆå…§å®¹æ˜¯ç©ºçš„");

            // --- ç²¾æº–å®šä½ ---
            let headerRowIndex = -1;
            let colMap = { name: -1, date: -1, type: -1, shift: -1, start: -1, end: -1, base: -1 };

            for (let i = 0; i < Math.min(rawData.length, 20); i++) {
               const rowStr = JSON.stringify(rawData[i]);
               if (rowStr.includes("å§“å") && rowStr.includes("æ‰“å¡æ—¥æœŸ")) {
                   headerRowIndex = i;
                   log(`âœ… æ‰¾åˆ°æ¨™é¡Œ (Row ${i+1})`);
                   
                   rawData[i].forEach((cell, idx) => {
                       const txt = String(cell).trim();
                       if (txt === "å§“å") colMap.name = idx;
                       else if (txt === "æ‰“å¡æ—¥æœŸ") colMap.date = idx;
                       else if (txt === "æ—¥æœŸé¡åˆ¥") colMap.type = idx;
                       else if (txt === "ç­åˆ¥") colMap.shift = idx;
                       else if (txt === "ä¸Šç­æ‰“å¡æ™‚é–“") colMap.start = idx;
                       else if (txt === "ä¸‹ç­æ‰“å¡æ™‚é–“") colMap.end = idx;
                       else if (txt === "è¨ˆè–ªåŸºæº–å·¥æ™‚") colMap.base = idx;
                   });
                   break;
               }
            }

            if (headerRowIndex === -1 || colMap.name === -1) throw new Error("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—");
            if (colMap.start === -1) throw new Error("âŒ æ‰¾ä¸åˆ° [ä¸Šç­æ‰“å¡æ™‚é–“]");
            
            // --- æŠ“å–è³‡æ–™ ---
            const mergedMap = {}; 
            for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                const row = rawData[i];
                const name = row[colMap.name];
                const date = row[colMap.date];

                if (!name || !date) continue; 

                const key = name + "_" + date;
                let currentBase = (colMap.base !== -1) ? row[colMap.base] : "";

                if (!mergedMap[key]) {
                    mergedMap[key] = {
                        name: name, date: date, type: row[colMap.type], shift: row[colMap.shift],
                        start: "--", end: "--", base: currentBase
                    };
                } else {
                    if ((!mergedMap[key].base) && currentBase) mergedMap[key].base = currentBase;
                }

                const startVal = row[colMap.start];
                const endVal = row[colMap.end];
                if (startVal && String(startVal).trim() !== "--") mergedMap[key].start = startVal;
                if (endVal && String(endVal).trim() !== "--") mergedMap[key].end = endVal;
            }

            const cleanData = Object.values(mergedMap).map(item => {
                return [ item.name, item.date, item.type, item.shift, item.start, item.end, item.base ];
            });

            log(`ğŸ“¦ è§£æå®Œæˆï¼Œæº–å‚™ä¸Šå‚³ ${cleanData.length} ç­†è³‡æ–™...`);

            // â˜… 3. æ”¹ç”¨ API å‘¼å« (importCleanData)
            callApi('importCleanData', cleanData)
              .then(res => {
                  if (res.status === 'success') {
                      log("ğŸ‰ " + res.message, 'success');
                      // 3ç§’å¾Œæ¢å¾©æŒ‰éˆ•
                      setTimeout(() => toggleAll(false), 3000);
                  } else {
                      throw new Error(res.message);
                  }
              })
              .catch(err => {
                  log("âŒ ä¸Šå‚³å¤±æ•—: " + err.message, 'error');
                  toggleAll(false);
              });

          } catch (err) {
            log("âŒ è™•ç†éŒ¯èª¤: " + err.message, 'error');
            toggleAll(false);
          }
      }
    </script>
  </body>
</html>
