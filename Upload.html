<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
      body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; padding: 15px; background: #f4f4f4; text-align: center; color: #333; }
      .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      h3 { margin-top: 0; margin-bottom: 15px; font-weight: 600; color: #2c3e50; }
      
      /* UI å…ƒä»¶æ¨£å¼ */
      select { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; background: #fff; box-sizing: border-box; }
      
      .btn { 
        display: block; width: 100%; padding: 12px; margin-top: 10px; 
        border: none; border-radius: 6px; cursor: pointer; 
        font-size: 15px; font-weight: 500; transition: all 0.2s ease; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .btn:active { transform: translateY(1px); box-shadow: none; }
      .btn:disabled { background: #ccc !important; cursor: not-allowed; transform: none; box-shadow: none; }

      .btn-load { background: #17a2b8; color: white; }    /* é’è‰²ï¼šè®€å–åˆ—è¡¨ */
      .btn-load:hover { background: #138496; }

      .btn-action { background: #28a745; color: white; }  /* ç¶ è‰²ï¼šåŸ·è¡ŒåŒ¯å…¥ */
      .btn-action:hover { background: #218838; }

      .btn-primary { background: #007bff; color: white; } /* è—è‰²ï¼šæ‰‹å‹• */
      .btn-primary:hover { background: #0056b3; }
      
      .divider { margin: 25px 0; border-top: 1px solid #e0e0e0; position: relative; }
      .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 12px; color: #999; font-size: 12px; }

      #log { margin-top: 15px; font-size: 13px; text-align: left; background: #2d3436; color: #dfe6e9; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto; display: none; font-family: monospace; }
      
      /* éš±è—å€å¡Š */
      #driveSection { display: none; margin-top: 15px; animation: fadeIn 0.5s; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      
      input[type="file"] { margin-top: 10px; font-size: 14px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>ğŸ“ æ‰“å¡è³‡æ–™åŒ¯å…¥ç³»çµ±</h3>
      
      <button id="loadListBtn" class="btn btn-load" onclick="loadDriveList()">
        ğŸ“‚ è¼‰å…¥é›²ç«¯æª”æ¡ˆåˆ—è¡¨
      </button>

      <div id="driveSection">
        <select id="fileSelect">
           <option value="">è¼‰å…¥ä¸­...</option>
        </select>
        <button id="autoImportBtn" class="btn btn-action" onclick="importSelectedFile()">
           â¬‡ï¸ åŒ¯å…¥é¸å–çš„æª”æ¡ˆ
        </button>
      </div>

      <div class="divider"><span>æˆ– æ‰‹å‹•ä¸Šå‚³</span></div>

      <p style="margin:0 0 5px; font-size:14px; color:#666;">é¸æ“‡é›»è…¦ä¸­çš„ Excel æª”æ¡ˆ</p>
      <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" />
      <button id="manualBtn" class="btn btn-primary" onclick="manualImport()">
        ğŸš€ æ‰‹å‹•åŒ¯å…¥
      </button>
      
      <div id="log"></div>
    </div>

    <script>
      // === è¼”åŠ©å‡½å¼ ===
      function log(msg, type='') {
        const logDiv = document.getElementById('log');
        logDiv.style.display = 'block';
        
        let color = '#dfe6e9'; // é è¨­ç™½
        if (type === 'error') color = '#ff7675'; // ç´…
        if (type === 'success') color = '#55efc4'; // ç¶ 
        
        const timestamp = new Date().toLocaleTimeString('en-US', {hour12: false});
        logDiv.innerHTML += `<div style="color:${color}; border-bottom:1px solid #444; padding:2px 0;">[${timestamp}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function toggleAll(isLoading, loadingText = '') {
         const ids = ['loadListBtn', 'autoImportBtn', 'manualBtn', 'fileSelect', 'excelFile'];
         ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.disabled = isLoading;
         });
         
         // ç°¡å–®çš„ Loading è¦–è¦ºå›é¥‹
         if(loadingText) {
             document.activeElement.setAttribute('data-original-text', document.activeElement.innerText);
             document.activeElement.innerText = loadingText;
         } else {
             // æ¢å¾©æ–‡å­— (å¦‚æœéœ€è¦çš„è©±ï¼Œé€™è£¡ç°¡åŒ–è™•ç†ï¼Œç›´æ¥æ¢å¾©åŠŸèƒ½)
             const loadBtn = document.getElementById('loadListBtn');
             if(loadBtn.innerText === 'â³ è®€å–ä¸­...') loadBtn.innerText = 'ğŸ“‚ è¼‰å…¥é›²ç«¯æª”æ¡ˆåˆ—è¡¨';
         }
      }

      // --- åŠŸèƒ½ 1ï¼šè¼‰å…¥åˆ—è¡¨ ---
      function loadDriveList() {
         const btn = document.getElementById('loadListBtn');
         const originalText = btn.innerText;
         btn.innerText = "â³ è®€å–ä¸­...";
         
         toggleAll(true);
         log("ğŸ“¡ é€£ç·š Google Drive...");
         
         google.script.run
           .withSuccessHandler(function(list) {
              const select = document.getElementById('fileSelect');
              select.innerHTML = ""; 
              
              if (list.length === 0) {
                 select.innerHTML = "<option>âŒ æ‰¾ä¸åˆ° XLSX æª”æ¡ˆ</option>";
                 log("âš ï¸ è³‡æ–™å¤¾å…§æ²’æœ‰ Excel æª”æ¡ˆ", 'error');
              } else {
                 list.forEach(f => {
                    let opt = document.createElement('option');
                    opt.value = f.id;
                    let dateStr = new Date(f.updated).toLocaleDateString();
                    opt.text = `[${dateStr}] ${f.name}`;
                    select.add(opt);
                 });
                 document.getElementById('driveSection').style.display = 'block';
                 log(`âœ… åˆ—è¡¨è¼‰å…¥å®Œæˆï¼Œå…± ${list.length} å€‹æª”æ¡ˆã€‚`, 'success');
              }
              btn.innerText = originalText;
              toggleAll(false);
           })
           .withFailureHandler(function(err) {
              log("âŒ è®€å–åˆ—è¡¨å¤±æ•—: " + err.message, 'error');
              btn.innerText = originalText;
              toggleAll(false);
           })
           .getDriveFileList();
      }

      // --- åŠŸèƒ½ 2ï¼šåŒ¯å…¥é¸å–çš„æª”æ¡ˆ ---
      function importSelectedFile() {
         const fileId = document.getElementById('fileSelect').value;
         if (!fileId) return;

         const btn = document.getElementById('autoImportBtn');
         const originalText = btn.innerText;
         btn.innerText = "ğŸ“¥ ä¸‹è¼‰è§£æä¸­...";

         toggleAll(true);
         log("ğŸ”„ é–‹å§‹ä¸‹è¼‰æª”æ¡ˆ...");

         google.script.run
           .withSuccessHandler(function(res) {
              log(`ğŸ“¥ ä¸‹è¼‰å®Œæˆ (${res.filename})ï¼Œé–‹å§‹è§£æ...`);
              
              // Base64 è§£ç¢¼
              try {
                  const binaryString = window.atob(res.base64);
                  const len = binaryString.length;
                  const bytes = new Uint8Array(len);
                  for (let i = 0; i < len; i++) {
                      bytes[i] = binaryString.charCodeAt(i);
                  }
                  processData(bytes);
                  btn.innerText = originalText;
              } catch (e) {
                  log("âŒ è§£æå¤±æ•—: " + e.message, 'error');
                  btn.innerText = originalText;
                  toggleAll(false);
              }
           })
           .withFailureHandler(function(err) {
              log("âŒ ä¸‹è¼‰å¤±æ•—: " + err.message, 'error');
              btn.innerText = originalText;
              toggleAll(false);
           })
           .getFileContentById(fileId);
      }

      // --- åŠŸèƒ½ 3ï¼šæ‰‹å‹•åŒ¯å…¥ ---
      function manualImport() {
        const fileInput = document.getElementById('excelFile');
        if (typeof XLSX === 'undefined') { log("âŒ Excel å·¥å…·åŒ…è¼‰å…¥å¤±æ•—", 'error'); return; }
        if (fileInput.files.length === 0) { log("âŒ è«‹å…ˆé¸æ“‡æª”æ¡ˆ", 'error'); return; }

        const btn = document.getElementById('manualBtn');
        const originalText = btn.innerText;
        btn.innerText = "â³ è™•ç†ä¸­...";

        toggleAll(true);
        log("â³ è®€å–ä¸Šå‚³æª”æ¡ˆä¸­...");
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          processData(data);
          btn.innerText = originalText;
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
      }

      // ==========================================================
      // â˜…â˜…â˜… é»ƒé‡‘è§£æé‚è¼¯ (Golden Logic) â˜…â˜…â˜…
      // ==========================================================
      function processData(data) {
        try {
            const workbook = XLSX.read(data, {type: 'array'});
            
            if (workbook.SheetNames.length < 2) throw new Error("æ­¤æª”æ¡ˆåªæœ‰ 1 å€‹åˆ†é ï¼Œæ‰¾ä¸åˆ°ç¬¬ 2 é  (Rawdata)ï¼");
            const sheetName = workbook.SheetNames[1]; 
            log(`ğŸ“„ è®€å–åˆ†é : [${sheetName}]`);
            
            const worksheet = workbook.Sheets[sheetName];
            const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});

            if (rawData.length < 2) throw new Error("æª”æ¡ˆå…§å®¹æ˜¯ç©ºçš„");

            // --- ç²¾æº–å®šä½ ---
            let headerRowIndex = -1;
            let colMap = { name: -1, date: -1, type: -1, shift: -1, start: -1, end: -1, base: -1 };

            for (let i = 0; i < Math.min(rawData.length, 20); i++) {
               const rowStr = JSON.stringify(rawData[i]);
               if (rowStr.includes("å§“å") && rowStr.includes("æ‰“å¡æ—¥æœŸ")) {
                   headerRowIndex = i;
                   log(`âœ… æ‰¾åˆ°æ¨™é¡Œ (Row ${i+1})`);
                   
                   rawData[i].forEach((cell, idx) => {
                       const txt = String(cell).trim();
                       if (txt === "å§“å") colMap.name = idx;
                       else if (txt === "æ‰“å¡æ—¥æœŸ") colMap.date = idx;
                       else if (txt === "æ—¥æœŸé¡åˆ¥") colMap.type = idx;
                       else if (txt === "ç­åˆ¥") colMap.shift = idx;
                       else if (txt === "ä¸Šç­æ‰“å¡æ™‚é–“") colMap.start = idx;
                       else if (txt === "ä¸‹ç­æ‰“å¡æ™‚é–“") colMap.end = idx;
                       else if (txt === "è¨ˆè–ªåŸºæº–å·¥æ™‚") colMap.base = idx;
                   });
                   break;
               }
            }

            if (headerRowIndex === -1 || colMap.name === -1) throw new Error("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—");
            if (colMap.start === -1) throw new Error("âŒ æ‰¾ä¸åˆ° [ä¸Šç­æ‰“å¡æ™‚é–“]");
            
            // --- æŠ“å–è³‡æ–™ ---
            const mergedMap = {}; 
            for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                const row = rawData[i];
                const name = row[colMap.name];
                const date = row[colMap.date];

                if (!name || !date) continue; 

                const key = name + "_" + date;
                let currentBase = (colMap.base !== -1) ? row[colMap.base] : "";

                if (!mergedMap[key]) {
                    mergedMap[key] = {
                        name: name, date: date, type: row[colMap.type], shift: row[colMap.shift],
                        start: "--", end: "--", base: currentBase
                    };
                } else {
                    if ((!mergedMap[key].base) && currentBase) mergedMap[key].base = currentBase;
                }

                const startVal = row[colMap.start];
                const endVal = row[colMap.end];
                if (startVal && String(startVal).trim() !== "--") mergedMap[key].start = startVal;
                if (endVal && String(endVal).trim() !== "--") mergedMap[key].end = endVal;
            }

            const cleanData = Object.values(mergedMap).map(item => {
                return [ item.name, item.date, item.type, item.shift, item.start, item.end, item.base ];
            });

            log(`ğŸ“¦ è§£æå®Œæˆï¼Œæº–å‚™å¯«å…¥ ${cleanData.length} ç­†è³‡æ–™...`);

            google.script.run
              .withSuccessHandler(() => { log("ğŸ‰ åŒ¯å…¥æˆåŠŸï¼", 'success'); toggleAll(false); })
              .withFailureHandler((err) => { log("âŒ åŒ¯å…¥å¤±æ•—: " + err.message, 'error'); toggleAll(false); })
              .importCleanData(cleanData);

          } catch (err) {
            log("âŒ è™•ç†éŒ¯èª¤: " + err.message, 'error');
            toggleAll(false);
          }
      }
    </script>
  </body>
</html>
